# Getting Started with MongoDB

A **MongoDB Deployment** refers to the setup of MongoDB servers where our databases live (this can be local, self-hosted, or managed by MongoDB Atlas). 

When using Atlas, MongoDB manages and monitors the servers for us. 

> `NOTE`
> 
> If we host locally or on our own servers, we must handle monitoring,  backups, and scaling manually, which is less ideal for production.

## Connecting NodeJS to MongoDB

To connect to a MongoDB deployment, you need two things:

- **Connection URI**, also known as a *connection string*, which tells the Node.js driver which MongoDB deployment to connect to.
  
  > `URI`
  > 
  > - **Uniform Resource Identifier** It’s a *string* that uniquely identifies a resource.
  > 
  > - Contains all data about the resource (Here Type, Credentials, Host) 
  > 
  > - `URL` will just have the location of the Resource but `URI` all info about the resource to identify it.
  
  - | **Component**                     | **Description**                                                                                                       |
    | --------------------------------- | --------------------------------------------------------------------------------------------------------------------- |
    | `mongodb://` or `mongodb+srv://`* | Prefix that identifies this as a MongoDB connection string. (required)                                                |
    | `username:password@`              | Authentication credentials. If provided, driver authenticates user (using `authSource` DB).                           |
    | `host[:port]`*                    | Hostname or IP where MongoDB is running. Default port = `27017` if not specified. (required)                          |
    | `/defaultauthdb`                  | Default authentication database if credentials are provided but `authSource` is not. If missing, defaults to `admin`. |
    | `?<options>`                      | Query string with connection-specific options (`<name>=<value>` pairs). Example: `?replicaSet=mySet&ssl=true`.        |
    
        

- **MongoClient** object, which creates the connection to and performs operations on the MongoDB deployment.
  
  - As each `MongoClient` represents a pool of connections to the database, *most applications only require a single instance of a `MongoClient`, even across multiple requests.*
  
  - A **connection pool** is a **collection (group) of open network connections** that the driver keeps ready to use.
    
    - > When your app talks to MongoDB, it does so through **TCP network connections**.
      > - *If you opened & closed a new connection for every query  it would be very slow.*
      > 
      > - Instead, the **Node.js driver maintains a pool**:
      >   
      >   - A set of **pre-opened, reusable connections** to the database.
      >   
      >   - When your code runs a query, it “borrows” a connection from the pool, uses it, and then releases it back.

```js
const { MongoClient } = require("mongodb");

// Replace the placeholder with your Atlas connection string
const uri = "<connection string>";

// Create a MongoClient with a MongoClientOptions object to set the Stable API version
const client = new MongoClient(uri);

async function run() {
  try {
    // Connect the client to the server (optional starting in v4.7)
    await client.connect();
  } finally {
    // Ensures that the client will close when you finish/error
    await client.close();
  }
}
run().catch(console.dir);
```

> `NOTE`
> 
> Call the `MongoClient.connect()` method **explicitly if you want to verify** that the connection is successful. Since The Node.js driver *automatically calls the `MongoClient.connect()` method when using the client to perform CRUD operations*

### Fixing Slow Operations

Slow operations keep a connection to MongoDB occupied, which can cause other operations to wait until another connection becomes available.

Perform

1. Enable the database profiler on your deployment.

2. Enable connection pool monitoring.

If still experience delays, you can modify your connection settings to *increase the size of the connection pool.*

To specify the maximum size of a connection pool, you can set the `maxPoolSize` option in the connection options for your `MongoClient` instance.

```js
const client = new MongoClient(uri, {maxPoolSize: n})
// Where n is no.of active connections the driver should maintain
```

> `NOTE`
> 
>  Default no. of connections in pool is 100 , even if `maxPoolSize` is not specified in the Client Instance.
> 
> - It doesn’t immediately open 100 connections.
> 
> - It opens connections **on demand** (as queries come in), up to the limit (`maxPoolSize`).

If the number of in-use connections to a server reaches `maxPoolSize`, the next operation sent to the server pauses until a connection to the driver becomes available
