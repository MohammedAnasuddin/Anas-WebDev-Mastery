# Authentication

## Flow of Tokens

1. On Login Server will validate email and password create a `JWT` ,

2. Server will wrap this into `Cookie`

3. This Cookie will be send back as response to the User

4. Now On Every Request from User, this cookie also passed with request. (this is automatically done by browser/postman)

5. Server will validate the cookie an the request is processed. 

>  Cookies can be expired as well, if a Cookie is expired it will fail the validation form the server

## Implementation

### Creating a Cookie

use `res.cookie("name","token")` to send the cookie as an response from the server

### Getting a Cookie

use `req.cookies` to get all the attached cookies with the request made, But cookie cannot be directly read , we need to parse them.

To parse a cookie we need a middleware (just like express.json() ) , the middleware is

`cookie-parser`

```js
//app.js

const cookieParser = require("cookie-parser")
app.use(cookieParser())
```

## JWT

JSON Web Tokens have 3 parts 

1. Header 

2. Payload : Holds the Confidential Data

3. Signature: Used to Verify the Token.

> `NOTE`
> 
> Always await the JWT Methods 

### Creating JWT

1. Install the package `jsonwebtoken`

2. Require it and use `.sign` to create the token, it takes
   
   1. {data}: use the `_id` of the User's MongoDB Document to create the token
   
   2. "private_key":  Data which only server knows.
   
   Now, send this token with response using `res.cookies("name_of_token",token)`
   
   ```js
   const token =  jwt.sign({id: user._id},"private_key")
   res.cookie("token",token)
   ```

We can expire this token using `{expiresIn:"7d"}` option after the `private_key`

```js
const token = await jwt.sign({id:id},
        "learningNodeJS", 
        {expiresIn: "7d"})
```

>  Storing a token for 7 days is a good practice, if the user does not login in 7 days token gets deleted and user have to login again

> `NOTE`
> 
> Always have an expiry for the token , a user might login on someone else computer if not logout the other person can se users credentials

### Verifying the JWT

1. Get the cookies using `req.cookies`

2. Get the token from the Cookie by destructing or `cookie.nmae_of_token`

3. use `.verify(token,"private_key")` to get the data from token.

4. It returns  decoded data as `JSON`
   
   ```js
           const cookie = req.cookies
           const {token} =  cookie
           const decoded_token = await jwt.verify(token,"private_key")
           const {id} = decoded_token
   
           const required_user = await User.findById(id);
           res.send(required_user);
   ```

## Creating a User Auth MiddleWare

1. Create a Route Handler whihc performs the Verification of JWT as above

2. Validate the token and the userID 
   
   1. Each middleware function can read, modify, and add properties to `req, res` objects.
      
       Now, attach the user object you found in the database to the `req` object: `req.user = user`.

3. If everything ok, then call `next()`

4. Now, in API call which needs the Auth place this Route handler first followed by its Route handler eg : "/profile" => `userAuth, async(req, res){}`

This makes sure that user is authenticated before accessing the core routes logic.

> Because it's the *exact same* `req` object being passed along, the `user` property you added in the middleware is now available for the route handler to use as `req.user`.



```js
const jwt = require("jsonwebtoken")
const User = require("../models/User")


const auth_middleware = async (req,res,next)=>{
  try{
    const cookies = req.cookies
    const {token} = cookies
        if(!token){
            throw new Error("Token Does Not Exist")
        }

        const decodedToken = await jwt.verify(token,"learningNodeJS")
        const {id} = decodedToken
        const user = await User.findById(id)

        if(!user){
            throw new Error("User Does Not Exist")
        }
        req.user = user
        next()
} catch(e){
    
    res.status(401).send("Invalid token."+e.message)
}
}

module.exports = {
    auth_middleware
}
```


