# Working of libuv

## Components of  libuv

### Callback Queue

After the async task is performed it's corresponding callback stays in the `Callback_queue` until the `Callstack `of JS Engine is empty and then this callback is executed. 

Callback_Queue holds and manages he callbacks

### Event Loop

Checks for the emptiness(idle, non-busy) of `Callstack`, if found empty immediately pushes a callback from the `callback_queue` into the `CallStack` for execution

#### Working of Event Loop

Works as a cycle of Phases and in each phase is callbacks available it executes them.

> Here Callbacks executed refers to pushing them into the Callstack
> 
> Event Loop simultaneously checks for idle state of Callstack and if found idle then only it pushes the callbacks according to the current phase. 
> 
> `EventLoop` executes al the callbacks waiting in the callback queue of the respective phases. If a `respose of API` is waiting in Callback queue it will be executed(pushed on `CallStack`) when `EventLoop` traverses the `POLL` Phase 
> 
> After executing the callbacks they are removed from the callback queue.

`EventLoop` Traversal :

- `PHASE-1`: **TIMER**
  
  - All the callbacks consisting of timer functions will be executed 
  
  - `SetTimeout`, `SetInterval`

- `PHASE-2`: **POLL**
  
  - All the callbacks associated with `I/O` Operations are executed
  
  - Includes Reading/Writing Files, API Calls

- `PHASE-3`: **Check**
  
  - Callbacks which are scheduled using `setImmediate()` are executed

- `PHASE-4`: **CLOSE**
  
  - Callbacks which perform cleanup or closing actions are executed

    

Before going into any of the  above phases `EventLoop` will check for

1. `process.nextTick()` is checked for first and then

2. any callbacks of promises 

After checking these both the `EventLoop` enters into the Phase

> Phase-X since I don't know it's name

<img title="" src="../Diagrams/Flow of Event Loop Phases.png" alt="" data-align="right" width="638">

`EventLoop` will move on the next only after execution all the callbacks from the queue of the current phase i.e., until current phase queue becomes empty.



One Cycle of `EventLoop` is known as `Tick`



Example 

```js
const a = 100;

setImmediate(() => console.log("setImmediate"));

fs.readFile("./file.txt", "utf8", () => {
  console.log("File Reading CB");
});

setTimeout(() => console.log("Timer expired"), 0);

function printA() {
  console.log("a=", a);
}

printA();

console.log("Last line of the file.");
```

Flow of `EventLoop`

- `setImmediate()` goes in the callback queue

- Started Reading file.txt

- `setTimeout()` is added to the callback queue since there is `0` delay

- function `printA` is called function execution context is create for `printA` and it logs `"a=100"`

- Logs `"last line of the file"`

- `Eventloop` checks for `PHASE-X` not found go to `PHASE-timer`

- `setTimeout()` is in callback queue executes it(push it on Callstack ) which logs `"Timer Expired"`

- `Eventloop` checks for `PHASE-X` not found go to `PHASE-poll` also founds nothing (since still reading the file.txt)

- `Eventloop` checks for `PHASE-X` not found go to `PHASE-check`  

- Found a `setImmediate()` in callback queue Execute it Which logs `"setImmediate"`

- file.txt has been completely read and it's associate callback is added to callback queue

- `Eventloop` checks for `PHASE-X` not found go to `PHASE-close` also founds nothing 

- `Eventloop` checks for `PHASE-X` not found go to `PHASE-timer` also founds nothing

- `Eventloop` checks for `PHASE-X` not found go to `PHASE-poll`

- Found a I/O callback from reading operation executes it and logs `"File Reading CB"` 
  
  ```bash
  // Final Output
  a=100
  Last line of the file
  Timer Expired
  setImmediate
  Completed reading CB
  ```
  
  ```bash
   ┌──────────────────────────────────────────┐
   │ Synchronous Code                         │
   │  - printA() → "a= 100"                   │
   │  - "Last line of the file."              │
   └──────────────────────────────────────────┘
  PHASES: 
   ┌─────────────┬─────────┬────────────┬────────┬────────────┐
   │  Timers     │ Pending │   Poll     │ Check  │   Close    │
   └─────────────┴─────────┴────────────┴────────┴────────────┘
          │                    │             │
          ▼                    ▼             ▼
   "Timer expired"     (fs.readFile not   "setImmediate"
                       ready yet)
  
   ...next cycle...
   (file ready in Poll phase)
          ▼
   "File Reading CB"
  ```

If All Queue's are empty then `EventLoop` will waits at `PHASE-POLL`

When `EventLoop` is idle it waits at `PHASE-POLL` so as to execute any I/O callbacks as soon as there are received. Hence NodeJS `EventLoop` is known as semi infinite loop.

> Browser `EventLoop` does not waits t keeps on running.



##### Additional Phases

- **pending callbacks**: executes I/O callbacks deferred to the next loop iteration. This phase executes callbacks for some system operations such as types of TCP errors.
- **idle, prepare**: only used internally.
